<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no"/>

  <title>EMU explorer - Spilhaus</title>

  <style>
    html,
    body,
    #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
    }

    #verticalDiv{
      width: 250px;
      height: 600px;
    }
    #chartContainer {
      /* position: inherit; */
      padding-top: 10px;
      height: 600px;
      /* bottom: 20px; */
      width: 300px;
      z-index: 96;
    }

    #options {
      padding: 10px;
  }

  #containerDiv {
    padding: 10px;
    text-align: center;
    box-shadow: 0;
  }

  #histogram {
    width: 500px;
    height: 150px;
  }
  .labels {
    padding: 5px;
  }
  </style>

  <!-- Load the Chart.js library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.js"></script>

  <link rel="stylesheet" href="https://js.arcgis.com/next/esri/themes/light/main.css" />
  <script src="https://js.arcgis.com/next/"></script>

  <script>
    require([
      "esri/views/MapView",
      "esri/WebMap",
      "esri/layers/FeatureLayer",
      "esri/widgets/Slider",
      "esri/geometry/geometryEngine",
      "esri/renderers/support/jsonUtils",
      "esri/widgets/Histogram",
      "esri/renderers/smartMapping/statistics/histogram",
      "esri/renderers/smartMapping/statistics/summaryStatistics",
      "esri/symbols/CIMSymbol",
      "esri/core/lang",
      "esri/Color"
      ], function(
        MapView, WebMap, FeatureLayer,
        Slider, geometryEngine, rendererJsonUtils,
        Histogram, histogram, summaryStatistics, CIMSymbol, lang, Color
      ) {

        depthValues = [ 0, -5, -10, -15, -20, -25, -30, -35, -40, -45, -50, -55, -60, -65, -70, -75, -80, -85, -90, -95, -100, -125, -150, -175, -200, -225, -250, -275, -300, -325, -350, -375, -400, -425, -450, -475, -500, -550, -600, -650, -700, -750, -800, -850, -900, -950, -1000, -1050, -1100, -1150, -1200, -1250, -1300, -1350, -1400, -1450, -1500, -1550, -1600, -1650, -1700, -1750, -1800, -1850, -1900, -1950, -2000, -2100, -2200, -2300, -2400, -2500, -2600, -2700, -2800, -2900, -3000, -3100, -3200, -3300, -3400, -3500, -3600, -3700, -3800, -3900, -4000, -4100, -4200, -4300, -4400, -4500, -4600, -4700 ];
        directionDepthValues = [ -5, -10, -30, -40, -50, -65, -95, -150, -200, -275, -325, -375, -450]// -650, -750, -850, -1150, -2100, -2500, -2900];
        depthValues = [ 0, -5, -10, -15, -20, -25, -30, -35, -40, -45, -50, -55, -60, -65, -70, -75, -80, -85, -90, -95, -100, -125, -150, -175, -200, -225, -250, -275, -300, -325, -350, -375, -400, -425, -450, -475, -500, -550, -600, -650, -700, -750, -800, -850, -900, -950, -1000, -1050, -1100, -1150, -1200, -1250, -1300, -1350, -1400, -1450, -1500, -1550, -1600, -1650, -1700, -1750, -1800, -1850, -1900, -1950, -2000, -2100, -2200, -2300, -2400, -2500, -2600, -2700, -2800, -2900, -3000, -3100, -3200, -3300, -3400, -3500, -3600, -3700, -3800, -3900, -4000, -4100, -4200, -4300, -4400, -4500, -4600, -4700 ];
        const numDepthLevels = 80;  //depthValues.length;

        const depthSlider = new Slider({
          container: document.getElementById("depthSlider"),
          values: [ 0 ],
          min: -600,//depthValues[numDepthLevels-1], //-4700,  // -600
          max: 0,
          layout: "vertical",
          precision: 0,
          // labelsVisible: true,
          // rangeLabelsVisible: true,
          steps: depthValues,
          visibleElements: {
            labels: true,
            rangeLabels: true
          }
        });

        // const variables = [ "salinity", "temp", "dissO2", "nitrate", "phosphate", "silicate", "Direction", "Velocity" ];
        // const variables = [ "salinity", "temp", "dissO2", "nitrate", "phosphate", "silicate", "Direction", "Velocity" ];
        const variables = [ "salinity", "temp", "dissO2", "nitrate", "phosphate", "silicate", "Direction", "Velocity" ];


        let variable = variables[1];


        function createVariableSelect(){
          const select = document.createElement("select");
          select.classList.add("esri-widget");
          const optionsDiv = document.getElementById("options");
          optionsDiv.appendChild(select);

          variables.forEach( (variable, i) => {
            const option = document.createElement("option");
            option.value = variable;
            option.innerText = variable;
            option.selected = i === 0;
            select.appendChild(option);
          });

          select.addEventListener("change", (event) => {
            variable = select.value;
            const variableFields = createOutFields(variable)
            emuLayer.outFields = variableFields;
            updateRenderer();
            // updateRotationRenderer();
          });
        }



        getLevelFromDepth = function (depth) {
          const index = depthValues.indexOf(depth);
          return index > -1 ? index + 1 : null;
        }

        function createOutFields (variable){
          return depthValues
            .map( (value, i) => `${variable}_${i+1}`)
            .slice(0,numDepthLevels);
        }

        // console.log(createOutFields(variable));

        const salinityFields = createOutFields("salinity");
        const velocityFields = createOutFields("Velocity");
        const tempFields = createOutFields("temp");
        const directionFields = createOutFields("Direction");
        const outFields = velocityFields.concat(tempFields, salinityFields, directionFields);
        // const outFields = createOutFields(variable) // salinityFields.concat(velocityFields);  //createOutFields(variable)
        console.log(outFields);

        const currentsLayer = new FeatureLayer({
          portalItem: {
            id: "46b28da7ed5b4f28a6fab6ba75f4bdbc",
            portal: {
              url: "https://devext.arcgis.com"
            }
          },
          popupEnabled: false,
          // spatialReference: { wkid: 54010 }
        })

        emuLayer = new FeatureLayer({
          portalItem: {
            id: "2b85d9fa877149ae89f1194910c555a4",
            portal: {
              url: "https://qaext.arcgis.com"
            }
          },
          outFields: outFields,
          popupEnabled: false,
          // spatialReference: { wkid: 54010 }
        });


        const colors = {
          "salinity": [ "#fee6ce", "#fdae6b", "#e6550d" ],
          "temp": [ "#1993ff", "#2e6ca4", "#403031", "#a6242e", "#ff2638" ],
          "dissO2": [ "#edf8b1", "#7fcdbb", "#2c7fb8" ],
          "nitrate": [ "#e0ecf4", "#9ebcda", "#8856a7" ],
          "phosphate": [  "#e6f4ff", "#6f9988",  "#2c593f"],
          "silicate": [ "#e5f5e0", "#a1d99b", "#31a354" ],
          "Velocity": [ "#deebf7", "#9ecae1", "#3182bd" ],
          "Direction": [ "#eae2bb", "#c59ca4", "#1d4e89" ]
        };

        const variableConfig = {
          "salinity": {
            colors: [ "#fee6ce", "#fdae6b", "#e6550d" ],
            chartOptions: {
              min: 32,
              max: 37
            },
            stops: [
              { value: 33/*31.6*/, color: colors.salinity[0] },
              { value: 34.0, color: colors.salinity[1] },
              { value: 36.4, color: colors.salinity[2] }
            ]
          },
          "temp": {
            colors: [ "#1993ff", "#2e6ca4", "#403031", "#a6242e", "#ff2638" ],
            chartOptions: {
              min: -2,
              max: 30
            },
            stops: [
              // { value: 0/*2*/, color: colors.temp[0] },
              // { value: 15 /*13*/, color: colors.temp[1] },
              // { value: 30, color: colors.temp[2] }


              { value: 0/*2*/, color: colors.temp[0] },
              { value: 5 /*13*/, color: colors.temp[1] },
              { value: 15, color: colors.temp[2] },
              { value: 27/*2*/, color: colors.temp[3] },
              { value: 30 /*13*/, color: colors.temp[4] }
            ]
          },
          "dissO2": {
            colors: [ "#edf8b1", "#7fcdbb", "#2c7fb8" ],
            chartOptions: {
              min: 0,
              max: 10
            },
            stops: [
              { value: 4.75/*31.6*/, color: colors.dissO2[0] },
              { value: 6.19, color: colors.dissO2[1] },
              { value: 8, color: colors.dissO2[2] }
            ]
          },
          "nitrate": {
            colors: [ "#e0ecf4", "#9ebcda", "#8856a7" ],
            chartOptions: {
              min: 0,
              max: 50
            },
            stops: [
              { value: 12/*31.6*/, color: colors.nitrate[0] },
              { value: 25, color: colors.nitrate[1] },
              { value: 30, color: colors.nitrate[2] }
            ]
          },
          "phosphate": {
            colors: [ "#e6f4ff", "#6f9988",  "#2c593f"],
            chartOptions: {
              min: 0,
              max: 3
            },
            stops: [
              { value: 0.07/*31.6*/, color: colors.phosphate[0] },
              { value: 1, color: colors.phosphate[1] },
              { value: 2, color: colors.phosphate[2] }
            ]
          },
          "silicate": {
            colors: [ "#e5f5e0", "#a1d99b", "#31a354" ],
            chartOptions: {
              min: 0,
              max: 175
            },
            stops: [
              { value: 2/*31.6*/, color: colors.silicate[0] },
              { value: 50, color: colors.silicate[1] },
              { value: 150, color: colors.silicate[2] }
            ]
          },
          "Velocity": {
            colors: [ "#deebf7", "#9ecae1", "#3182bd" ],
            chartOptions: {
              min: 0,
              max: 0.5
            },
            stops: [
              { value: 0, color: colors.Velocity[0] },
              { value: 0.09, color: colors.Velocity[1] },
              { value: 0.2, color: colors.Velocity[2] }
            ]
          },
          "Direction": {
            colors: [ "#eae2bb", "#c59ca4", "#1d4e89" ],
            chartOptions: {
              min: 0,
              max: 360
            },
            stops: [
              { value: 0, color: colors.Direction[0] },
              { value: 180, color: colors.Direction[1] },
              { value: 360, color: colors.Direction[2] }
            ]
          }
        };

        let emuLayerView;

        function updateRenderer(){
          emuLayer.renderer = {
            type: "simple",
            symbol: {
              type: "simple-marker",
              size: 4,
              outline: {
                width: 0,
                color: [255,255,255,0.5]
              }
            },
            visualVariables: [{
              type: "color",
              field: `${variable}_${getLevelFromDepth(depthSlider.values[0])}`,
              stops: variableConfig[variable].stops
            }]
          }
        }

        function updateRotationRenderer(){

          // depthSlider.steps = directionDepthValues;

          const variableField = `${variable}_${getLevelFromDepth(depthSlider.values[0])}`;
          const velocityField = `Velocity_${getLevelFromDepth(depthSlider.values[0])}`;
          const directionField = `Direction_${getLevelFromDepth(depthSlider.values[0])}`;

          emuLayerView.filter = {
            where: `${variableField} IS NOT NULL AND ${velocityField} IS NOT NULL AND ${directionField} IS NOT NULL`
          };

          emuLayer.renderer = {
            type: "simple",
            symbol: {
              type: "web-style",
              name: "tear-pin-1",
              styleName: "Esri2DPointSymbolsStyle"
            },
            visualVariables: [{
              type: "color",
              field: variableField,
              stops: variableConfig[variable].stops
            }, {
              type: "size",
              field: velocityField,
              minDataValue: 0,
              maxDataValue: 0.5,
              minSize: "4px",
              maxSize: "12px"  //18
            }, {
              type: "rotation",
              valueExpression: `$feature.${directionField} - 180`,
              rotationType: "geographic"
            }]
          };
        }

        depthSlider.on(["thumb-change", "thumb-drag"], updateRenderer);
        // depthSlider.on(["thumb-change", "thumb-drag"], updateSalinityTempRelationship);
        // depthSlider.on(["thumb-change", "thumb-drag"], updateRotationRenderer);

        const webmap = new WebMap({
          // portalItem: {
          //   id: "e6c998e10de7442c832b66bf4916ef32",
          //   portal: {
          //     url: "https://devext.arcgis.com"
          //   }
          // },
          portalItem: {
            id: "06d3dc52f5cb4ddc96825b399919e916",
            portal: {
              url: "https://qaext.arcgis.com"
            }
          },
          layers: [ emuLayer, currentsLayer ]
        });

        view = new MapView({
          map: webmap,
          container: "viewDiv",
          // center: [0,0],
          // scale: 5000000,
          // spatialReference: { wkid: 54010 }
        });
        view.ui.add("verticalDiv", "top-right");
        view.ui.add("chartContainer", "bottom-left");
        view.ui.add("options", "bottom-right");
        view.ui.add("containerDiv", "bottom-left");
        containerDiv

        view.when().then(function(){
          createVariableSelect();
        });



        view.whenLayerView(emuLayer)
          .then(function(lv){
            emuLayerView = lv;
            createChart();

            depthSlider.steps = directionDepthValues;
            depthSlider.values = [-5];
            // updateSalinityTempRelationship();
             updateRenderer();
            // updateRotationRenderer();
          });

        view.on("pointer-move", function(event){
          view.hitTest(event)
            .then(function(hitResponse){
              if(hitResponse.results.length < 1){
                return;
              }

              console.log(hitResponse);

              const emuHit = hitResponse.results
                .map( result => result.graphic )
                .filter( graphic => graphic.layer.title === emuLayer.title )[0];


              if(emuHit){
                updateChart(emuHit);
              }
            });
        });



        view.on("click", function(event){
          view.hitTest(event)
            .then(function(hitResponse){
              console.log(hitResponse);

              const currentHit = hitResponse.results
                .map( result => result.graphic )
                .filter( graphic => graphic.layer.title === currentsLayer.title )[0];


              // positiveHit.geometry;
              if(currentHit){
                filterByGeometry(currentHit.geometry);
              } else {
                clearFilter();
              }
              // buffer(positiveHit.geometry);
            });
        });


        function filterByGeometry(geometry){
          clearFilter();

          // emuLayerView.filter = {
          //   geometry: geometryEngine.buffer(geometry, 100, "kilometers"),
          //   // distance: 100000,
          //   // units: "kilometers",
          //   // spatialRelationship: "intersects"
          // };

          emuLayerView.effect = {
            excludedEffect: "grayscale(100%) opacity(30%)",
            filter: {
              geometry: geometryEngine.buffer(geometry, 800, "kilometers"),
              // distance: 100000,
              // units: "kilometers",
              // spatialRelationship: "intersects"
            }
          }


          const query = emuLayerView.createQuery();
          query.geometry = emuLayerView.effect.filter.geometry;
          emuLayerView.queryFeatures(query).then(function(response){
            return response.features;
          }).then(updateHistogram);
        }



        function buffer(geometry){
          // var result = geometryEngine.buffer(geometry, 100, "kilometers");
          try{
            var result = geometryEngine.geodesicBuffer(geometry, 500, "kilometers");
            console.log(result);
          } catch(e){
            console.log(e);
          }
        }

        function clearFilter(){
          emuLayerView.filter = null;
          emuLayerView.effect = null;
        }

        const cimData = {
          "type":"CIMPointSymbol",
          "symbolLayers":[
            {
              "type":"CIMVectorMarker",
              "enable":true,
              "anchorPoint":{
                "x":0,
                "y":-0.5
              },
              "anchorPointUnits":"Relative",
              "dominantSizeAxis3D":"Y",
              "size":18.5,
              "billboardMode3D":"FaceNearPlane",
              "frame":{
                "xmin":0.0,
                "ymin":0.0,
                "xmax":21.0,
                "ymax":21.0
              },
              "markerGraphics":[
                {
                  "type":"CIMMarkerGraphic",
                  "geometry":{
                    "rings":[
                      [
                        [
                          17.17,
                          14.33
                        ],
                        [
                          16.97,
                          12.96
                        ],
                        [
                          16.38,
                          11.37
                        ],
                        [
                          12.16,
                          3.98
                        ],
                        [
                          11.2,
                          1.94
                        ],
                        [
                          10.5,
                          0.0
                        ],
                        [
                          9.8,
                          1.96
                        ],
                        [
                          8.84,
                          4.02
                        ],
                        [
                          4.61,
                          11.41
                        ],
                        [
                          4.02,
                          12.98
                        ],
                        [
                          3.83,
                          14.33
                        ],
                        [
                          3.96,
                          15.63
                        ],
                        [
                          4.34,
                          16.88
                        ],
                        [
                          4.95,
                          18.03
                        ],
                        [
                          5.78,
                          19.04
                        ],
                        [
                          6.8,
                          19.88
                        ],
                        [
                          7.95,
                          20.49
                        ],
                        [
                          9.2,
                          20.87
                        ],
                        [
                          10.5,
                          21.0
                        ],
                        [
                          11.8,
                          20.87
                        ],
                        [
                          13.05,
                          20.5
                        ],
                        [
                          14.2,
                          19.88
                        ],
                        [
                          15.22,
                          19.05
                        ],
                        [
                          16.05,
                          18.03
                        ],
                        [
                          16.66,
                          16.88
                        ],
                        [
                          17.04,
                          15.63
                        ],
                        [
                          17.17,
                          14.33
                        ]
                      ]
                    ]
                  },
                  "symbol":{
                    "type":"CIMPolygonSymbol",
                    "symbolLayers":[
                      {
                        "type":"CIMSolidStroke",
                        "enable":true,
                        "capStyle":"Round",
                        "joinStyle":"Round",
                        "lineStyle3D":"Strip",
                        "miterLimit":10,
                        "width":0,
                        "color":[
                          110,
                          110,
                          110,
                          255
                        ]
                      },
                      {
                        "type":"CIMSolidFill",
                        "enable":true,
                        "color":[
                          201,
                          49,
                          0,
                          255
                        ]
                      }
                    ]
                  }
                }
              ],
              "scaleSymbolsProportionally":true,
              "respectFrame":true
            }
          ],
          "haloSize":1,
          "scaleX":1,
          "angleAlignment":"Display",
          "version":"2.0.0",
          "build":"8933"
        };

        function updateSalinityTempRelationship(){
          const level = getLevelFromDepth(depthSlider.values[0]);

          const field1 = `salinity_${level}`;
          const field2 = `temp_${level}`;
          const velocityField = `Velocity_${getLevelFromDepth(depthSlider.values[0])}`;
          const directionField = `Direction_${getLevelFromDepth(depthSlider.values[0])}`;


          const visualVariables = [{
            type: "size",
            field: velocityField,
            minDataValue: 0,
            maxDataValue: 0.5,
            minSize: "4px",
            maxSize: "12px"  //18
          }, {
            type: "rotation",
            valueExpression: `$feature.${directionField} - 180`,
            rotationType: "geographic"
          }];

          const renderer = rendererJsonUtils.fromJSON({
            "authoringInfo": {
              "classificationMethod": "esriClassifyQuantile",
              "field1": {
                "field": field1,
                "normalizationField": "",
                "classBreakInfos": [
                  {
                    "minValue": 5.017099857330322,
                    "maxValue": 33.93169021606445
                  },
                  {
                    "minValue": 33.93169021606445,
                    "maxValue": 34.94491195678711
                  },
                  {
                    "minValue": 34.94491195678711,
                    "maxValue": 41.148712158203125
                  }
                ]
              },
              "field2": {
                "field": field2,
                "normalizationField": "",
                "classBreakInfos": [
                  {
                    "minValue": -1.8617100715637207,
                    "maxValue": 5.463809967041016
                  },
                  {
                    "minValue": 5.463809967041016,
                    "maxValue": 22.64011001586914
                  },
                  {
                    "minValue": 22.64011001586914,
                    "maxValue": 30.277099609375
                  }
                ]
              },
              "focus": "HH",
              "numClasses": 3,
              "type": "relationship"
            },
            "type": "uniqueValue",
            "valueExpression": `
              var field1 = $feature['${field1}'];
              var field2 = $feature['${field2}'];
              var hasNormField1 = false;
              var hasNormField2 = false;
              var normField1 = null;
              var normField2 = null;

              if (
                IsEmpty(field1) ||
                IsEmpty(field2) ||
                (hasNormField1 && (IsEmpty(normField1) || normField1 == 0)) ||
                (hasNormField2 && (IsEmpty(normField2) || normField2 == 0))
              ) {
                return null;
              }

              var value1 = IIf(hasNormField1, (field1 / normField1), field1);
              var value2 = IIf(hasNormField2, (field2 / normField2), field2);

              var breaks1 = [[5.017099857330322,33.93169021606445],[33.93169021606445,34.94491195678711],[34.94491195678711,41.148712158203125]];
              var breaks2 = [[-1.8617100715637207,5.463809967041016],[5.463809967041016,22.64011001586914],[22.64011001586914,30.277099609375]];
              var classCodes = [\"L\",\"M\",\"H\"];\n\n  function getClassCode(value, breaks) {
                var code = null;

                for (var i in breaks) {
                  var info = breaks[i];
                  if (value >= info[0] && value <= info[1]) {
                    code = classCodes[i];\
                    break;
                  }
                }

                return code;
              }

              var code1 = getClassCode(value1, breaks1);
              var code2 = getClassCode(value2, breaks2);\

              var classValue = IIf(IsEmpty(code1) || IsEmpty(code2), null, code1 + code2);
              return classValue;
            `,
            "valueExpressionTitle": "Relationship",
            "legendOptions": {},
            "uniqueValueInfos": [
  {
    "label": "High - High",
    "symbol": {
      "type": "esriSMS",
      "color": [
        6,
        107,
        45,
        255
      ],
      "angle": 0,
      "xoffset": 0,
      "yoffset": 0,
      "size": 6,
      "style": "esriSMSCircle",
      "outline": {
        "type": "esriSLS",
        "color": [
          153,
          153,
          153,
          64
        ],
        "width": 0.75,
        "style": "esriSLSSolid"
      }
    },
    "value": "HH"
  },
  {
    "label": "High - Medium",
    "symbol": {
      "type": "esriSMS",
      "color": [
        57,
        130,
        115,
        255
      ],
      "angle": 0,
      "xoffset": 0,
      "yoffset": 0,
      "size": 6,
      "style": "esriSMSCircle",
      "outline": {
        "type": "esriSLS",
        "color": [
          153,
          153,
          153,
          64
        ],
        "width": 0.75,
        "style": "esriSLSSolid"
      }
    },
    "value": "HM"
  },
  {
    "label": "High - Low",
    "symbol": {
      "type": "esriSMS",
      "color": [
        102,
        191,
        255,
        255
      ],
      "angle": 0,
      "xoffset": 0,
      "yoffset": 0,
      "size": 6,
      "style": "esriSMSCircle",
      "outline": {
        "type": "esriSLS",
        "color": [
          153,
          153,
          153,
          64
        ],
        "width": 0.75,
        "style": "esriSLSSolid"
      }
    },
    "value": "HL"
  },
  {
    "label": "Medium - High",
    "symbol": {
      "type": "esriSMS",
      "color": [
        125,
        119,
        85,
        255
      ],
      "angle": 0,
      "xoffset": 0,
      "yoffset": 0,
      "size": 6,
      "style": "esriSMSCircle",
      "outline": {
        "type": "esriSLS",
        "color": [
          153,
          153,
          153,
          64
        ],
        "width": 0.75,
        "style": "esriSLSSolid"
      }
    },
    "value": "MH"
  },
  {
    "label": "Medium - Medium",
    "symbol": {
      "type": "esriSMS",
      "color": [
        161,
        172,
        156,
        255
      ],
      "angle": 0,
      "xoffset": 0,
      "yoffset": 0,
      "size": 6,
      "style": "esriSMSCircle",
      "outline": {
        "type": "esriSLS",
        "color": [
          153,
          153,
          153,
          64
        ],
        "width": 0.75,
        "style": "esriSLSSolid"
      }
    },
    "value": "MM"
  },
  {
    "label": "Medium - Low",
    "symbol": {
      "type": "esriSMS",
      "color": [
        172,
        217,
        249,
        255
      ],
      "angle": 0,
      "xoffset": 0,
      "yoffset": 0,
      "size": 6,
      "style": "esriSMSCircle",
      "outline": {
        "type": "esriSLS",
        "color": [
          153,
          153,
          153,
          64
        ],
        "width": 0.75,
        "style": "esriSLSSolid"
      }
    },
    "value": "ML"
  },
  {
    "label": "Low - High",
    "symbol": {
      "type": "esriSMS",
      "color": [
        240,
        153,
        0,
        255
      ],
      "angle": 0,
      "xoffset": 0,
      "yoffset": 0,
      "size": 6,
      "style": "esriSMSCircle",
      "outline": {
        "type": "esriSLS",
        "color": [
          153,
          153,
          153,
          64
        ],
        "width": 0.75,
        "style": "esriSLSSolid"
      }
    },
    "value": "LH"
  },
  {
    "label": "Low - Medium",
    "symbol": {
      "type": "esriSMS",
      "color": [
        231,
        198,
        150,
        255
      ],
      "angle": 0,
      "xoffset": 0,
      "yoffset": 0,
      "size": 6,
      "style": "esriSMSCircle",
      "outline": {
        "type": "esriSLS",
        "color": [
          153,
          153,
          153,
          64
        ],
        "width": 0.75,
        "style": "esriSLSSolid"
      }
    },
    "value": "LM"
  },
  {
    "label": "Low - Low",
    "symbol": {
      "type": "esriSMS",
      "color": [
        242,
        242,
        242,
        255
      ],
      "angle": 0,
      "xoffset": 0,
      "yoffset": 0,
      "size": 6,
      "style": "esriSMSCircle",
      "outline": {
        "type": "esriSLS",
        "color": [
          153,
          153,
          153,
          64
        ],
        "width": 0.75,
        "style": "esriSLSSolid"
      }
    },
    "value": "LL"
  }
]
          });

          renderer.uniqueValueInfos.forEach(function(info){
            const color = info.symbol.color;

            const symbolData = lang.clone(cimData);
            symbolData.symbolLayers[0].markerGraphics[0].symbol.symbolLayers[1].color = color.toJSON();

            const symbol = new CIMSymbol({
              data: symbolData
            });

            info.symbol = symbol;
          });

          renderer.visualVariables = visualVariables;

          emuLayer.renderer = renderer;
        }

        let scatterChart = null;

        function createChart(){
          const chartCanvas = document.getElementById("line-chart");
          let xMin = 0;
          let xMax = 30;

          scatterChart = new Chart(chartCanvas.getContext("2d"), {
            type: 'scatter',
            data: {
              datasets: [{
                label: variable,
                backgroundColor: "#008837",
                borderColor: "#008837",
                data: [{
                  x: 0,
                  y: 0
                }]
              }]
            },
            options: {
                scales: {
                    xAxes: [{
                        type: 'linear',
                        position: 'top',
                        ticks: {
                          min: variableConfig[variable].chartOptions.min,
                          max: variableConfig[variable].chartOptions.max
                        }
                    }],
                //     xAxes: [
                //   {
                //     ticks: {
                //       beginAtZero: true,
                //       min: xMin,
                //       max: xMax,
                //       stepSize: 1,
                //       callback:(label, index, labels) => {
                //         return label % 5 === 0 ? label : "";
                //       }
                //     }
                //   }
                // ],
                // yAxes: [
                //   {
                //     ticks: {
                //       enabled: false,
                //       min: -3000,
                //       max: 0,
                //       stepSize: 150,
                //       callback:(label, index, labels) => {
                //         return label;// / 1000000 + " m";
                //       }
                //     }
                //   }
                // ]
                }
            }
        });

        }

      function updateChart(graphic){
        if(!scatterChart){
          createChart();
          return;
        }

        const attributes = graphic.attributes;
        let data = [];

        for (let key in attributes){
          const splitName = key.split("_");
          const variableName = splitName[0];
          const depthLevel = splitName[1];
          if (key.indexOf(variable) > -1){
            data.push({
              x: attributes[key],
              y: depthValues[depthLevel-1]
            });
          }
        }
        scatterChart.data.datasets[0].data = data;
        scatterChart.data.datasets[0].label = variable;
        scatterChart.data.datasets[0].backgroundColor = variableConfig[variable].colors[2];
        scatterChart.data.datasets[0].borderColor = variableConfig[variable].colors[2];

        scatterChart.options.scales.xAxes = [{
          type: 'linear',
          position: 'top',
          ticks: {
            min: variableConfig[variable].chartOptions.min,
            max: variableConfig[variable].chartOptions.max
          }
        }];
        scatterChart.update();
      }

      let histograms = {};
      let histogramChart = null;



      function getAverage(params) {
        return summaryStatistics(params).then(function(statistics) {
          return statistics.avg;
        });
      }

      function updateHistogram(features) {
        const variableField = `${variable}_${getLevelFromDepth(depthSlider.values[0])}`;

        if (histograms[variableField]) {
          histogramChart.bins = histograms[variableField];
        }

        // params for generating a histogram using the
        // points available on the client

        const params = {
          layer: emuLayer,
          field: variableField,
          view: view,
          features: features,
          numBins: 100,
        };

        let average = null;

        getAverage(params)
          .then(function(avg) {
            average = avg;
            return histogram(params);
          })
          .then(function(histogramResult) {
            // cache previously used histograms to improve performance
            histograms[variableField] = histogramResult.bins;

            if (!histogramChart) {
              histogramChart = new Histogram({
                container: "histogram",
                min: histogramResult.minValue,
                max: histogramResult.maxValue,
                bins: histogramResult.bins,
                average: average,
                // dataLines: [
                //   {
                //     value: 0
                //   }
                // ],
                dataLineCreatedFunction: function(element, label, index) {
                  if (index === 0) {
                    element.setAttribute("y2", "75%");
                  }
                },
                labelFormatFunction: function(value, type) {
                  return type === "average" ? value.toFixed(2) : value;
                },
                barCreatedFunction: function(index, element) {
                  const bin = histogramChart.bins[index];
                  const midValue = (bin.maxValue - bin.minValue) / 2 + bin.minValue;
                  const color = getColorFromValue(midValue);
                  element.setAttribute("fill", color.toHex());
                }
              });
            } else {
              histogramChart.bins = histogramResult.bins;
              histogramChart.average = average;
            }
          })
          .catch(function(e) {
            console.error(e);
          });
      }

      // Infers the color of the visual variable based on a given value
      // This is used to render and update histogram bars with colors
      // matching the features in the map
      function getColorFromValue(value) {
        const visualVariable = emuLayer.renderer.visualVariables.filter(function(
          vv
        ) {
          return vv.type === "color";
        })[0];
        const stops = visualVariable.stops;
        let minStop = stops[0];
        let maxStop = stops[stops.length - 1];

        let minStopValue = minStop.value;
        let maxStopValue = maxStop.value;

        if (value < minStopValue) {
          return minStop.color;
        }

        if (value > maxStopValue) {
          return maxStop.color;
        }

        const exactMatches = stops.filter(function(stop) {
          return stop.value === value;
        });

        if (exactMatches.length > 0) {
          return exactMatches[0].color;
        }

        minStop = null;
        maxStop = null;

        stops.forEach(function(stop, i) {
          if (!minStop && !maxStop && stop.value >= value) {
            minStop = stops[i - 1];
            maxStop = stop;
          }
        });

        const weightedPosition = (value - minStop.value) / (maxStop.value - minStop.value);

        return Color.blendColors(
          minStop.color,
          maxStop.color,
          weightedPosition
        );
      }
    });
  </script>
</head>

<body>
  <div id="viewDiv"></div>
  <div id="verticalDiv" class="esri-widget">
    <div id="depthSlider"></div>
  </div>

  <div id="chartContainer" class="esri-widget">
    <canvas id="line-chart" style="width:100%; height:100%;"></canvas>
  </div>

  <div id="options" class="esri-widget"></div>


  <div id="containerDiv" class="esri-widget">
    <div class="esri-widget">
      <div id="title" class="esri-widget">
        <h3>Histogram title</h3>
      </div>
      <div id="histogram" class="esri-widget"></div>
      <div class="labels esri-widget">
        <span style="float: left">-5° C</span>
        <span style="float: center">0° C</span>
        <span style="float: right">+5° C</span>
      </div>
    </div>
  </div>
</body>
</html>
