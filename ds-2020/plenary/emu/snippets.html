<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no"/>

  <title>EMU explorer - Spilhaus</title>

  <!-- Load the Chart.js library -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.js"></script>
  <script type="module" src="https://unpkg.com/@esri/calcite-components@1.0.0-beta.20/dist/calcite/calcite.esm.js"></script>
  <script nomodule="" src="https://unpkg.com/@esri/calcite-components@1.0.0-beta.20/dist/calcite/calcite.js"></script>
  <script src="https://js.arcgis.com/next/"></script>

  <link rel="stylesheet" type="text/css" href="https://unpkg.com/@esri/calcite-components@1.0.0-beta.20/dist/calcite/calcite.css">
  <link rel="stylesheet" href="https://js.arcgis.com/next/esri/themes/light/main.css" />
  <link rel="stylesheet" href="app.css" />


  <script>
    require([
      "esri/views/MapView",
      "esri/WebMap",
      "esri/layers/FeatureLayer",

      "esri/renderers/smartMapping/statistics/histogram",
      "esri/renderers/smartMapping/statistics/summaryStatistics",
      "esri/renderers/support/jsonUtils",
      "esri/symbols/CIMSymbol",
      "esri/Color",

      "esri/views/draw/Draw",
      "esri/Graphic",
      "esri/layers/GraphicsLayer",

      "esri/widgets/Histogram",
      "esri/widgets/Slider",
      "esri/widgets/Legend",
      "esri/widgets/Expand",
      "esri/widgets/Zoom",
      "esri/widgets/Bookmarks",
      "esri/webmap/Bookmark",

      "esri/geometry/geometryEngine",
      "esri/core/lang",
      "esri/core/watchUtils"
      ], function(
        MapView, WebMap, FeatureLayer,
        histogram, summaryStatistics, rendererJsonUtils, CIMSymbol, Color,
        Draw, Graphic, GraphicsLayer,
        Histogram, Slider, Legend, Expand, Zoom, Bookmarks, Bookmark,
        geometryEngine, lang, watchUtils
      ) {

        const depthValues = [ 0, -5, -10, -15, -20, -25, -30, -35, -40, -45, -50, -55, -60, -65, -70, -75, -80, -85, -90, -95, -100, -125, -150, -175, -200, -225, -250, -275, -300, -325, -350, -375, -400, -425, -450, -475, -500, -550, -600, -650, -700, -750, -800, -850, -900, -950, -1000, -1050, -1100, -1150, -1200, -1250, -1300, -1350, -1400, -1450, -1500, -1550, -1600, -1650, -1700, -1750, -1800, -1850, -1900, -1950, -2000, -2100, -2200, -2300, -2400, -2500, -2600, -2700, -2800, -2900, -3000, -3100, -3200, -3300, -3400, -3500, -3600, -3700, -3800, -3900, -4000, -4100, -4200, -4300, -4400, -4500, -4600, -4700 ];
        const directionDepthValues = [ -5, -10, -30, -40, -50, -65, -95, -150, -200, -275, -325, -375, -450] // -650, -750, -850, -1150, -2100, -2500, -2900];

        const depthSlider = new Slider({
          container: document.getElementById("depthSlider"),
          values: [ 0 ],
          min: -600,
          max: 0,
          layout: "vertical",
          precision: 0,
          steps: depthValues,
          visibleElements: {
            labels: false,
            rangeLabels: true
          }
        })

        let histogramChart = null;
        let binElements = [];

        const histogramMinElement = document.getElementById("histogram-min-label");
        const histogramMaxElement = document.getElementById("histogram-max-label");
        const histogramTitle = document.getElementById("histogram-title");

        let variable = "salinity";
        let lastHit = null;

        const currentsCheckbox = document.getElementById("currents-checkbox");
        const salinityRadio = document.getElementById("salinity-radio");
        const tempRadio = document.getElementById("temp-radio");
        const relationshipRadio = document.getElementById("relationship-radio");
        const variableSelect = document.getElementById("variable-select");

        const variableDisplay = document.getElementById("variable-display");
        const depthDisplay = document.getElementById("depth-display");
        const depthProfileDisplay = document.getElementById("depth-profile-title");

        variableSelect.addEventListener("calciteRadioGroupChange", updateVisualization);

        currentsCheckbox.addEventListener("calciteSwitchChange", function(event){
          currentsCheckbox.checked = event.srcElement.switched;
          if(currentsCheckbox.checked){
            depthSlider.steps = directionDepthValues;
            depthSlider.values = [ -5 ];
          } else {
            depthSlider.steps = depthValues;
            depthSlider.values = [ 0 ];
          }
          updateVisualization();
        });

        function updateVisualization(){

          depthDisplay.innerText = depthSlider.values[0] + "m"

          if(relationshipRadio.checked){
            variableDisplay.innerText = "Salinity & Temperature";
            updateSalinityTempRelationship(currentsCheckbox.checked);
            updateChart();
          } else {

            if (salinityRadio.checked){
              variable = "salinity";
              variableDisplay.innerText = "Salinity";
              depthProfileDisplay.innerText = "Salinity";
            } else {
              variable = "temp";
              variableDisplay.innerText = "Temperature (째C)";
              depthProfileDisplay.innerText = "Temperature (째C)";
            }

            variableDisplay.innerText = salinityRadio.checked ? "Salinity" : "Temperature (째C)"
            depthProfileDisplay.innerText = salinityRadio.checked ? "Salinity" : "Temperature (째C)"

            if (currentsCheckbox.checked){
              updateCurrentsRenderer();
            } else {
              updateRenderer();
            }

            updateHistogram(selectedFeatures);
            if(lastHit){
              updateChart(lastHit);
            }
          }
        }

        getLevelFromDepth = function (depth) {
          const index = depthValues.indexOf(depth);
          return index > -1 ? index + 1 : null;
        }

        const emuLayer = new FeatureLayer({
          title: "Observation Point",
          portalItem: {
            id: "06de2b96a7fa42d5891c4e79e17dd347",
            portal: {
              url: "https://qaext.arcgis.com"
            }
          },
          outFields: ["*"],
          popupEnabled: false
        });

        const variableConfig = {
          "salinity": {
            colors: [ "#fee6ce", "#fdae6b", "#e6550d" ],
            chartOptions: {
              min: 32,
              max: 40
            },
            stops: [
              { value: 33/*31.6*/, color: "#fee6ce" },
              { value: 34.0, color: "#fdae6b" },
              { value: 36.4, color: "#e6550d" }
            ]
          },
          "temp": {
            colors: [ "#1993ff", "#2e6ca4", "#403031", "#a6242e", "#ff2638" ],
            chartOptions: {
              min: -2,
              max: 30
            },
            stops: [
              { value: 0, color: "#1993ff" },
              { value: 5, color: "#2e6ca4" },
              { value: 15, color: "#403031" },
              { value: 27, color: "#a6242e" },
              { value: 30, color: "#ff2638" }
            ]
          }
        };

        let emuLayerView;

        function updateRenderer(){
          emuLayer.renderer = {
            type: "simple",
            symbol: {
              type: "simple-marker",
              size: 4,
              outline: {
                width: 0,
                color: [255,255,255,0.5]
              }
            },
            visualVariables: [{
              type: "color",
              legendOptions: {
                title: variable.charAt(0).toUpperCase() + variable.slice(1),
                showLegend: true
              },
              field: `${variable}_${getLevelFromDepth(depthSlider.values[0])}`,
              stops: variableConfig[variable].stops
            }, {
              type: "size",
              valueExpression: "$view.scale",
              stops: [
                { value: 7812500, size: 12 },
                { value: 15625000, size: 10 },
                { value: 31250000, size: 6 },
                { value: 62500000, size: 4 },
                { value: 125000000, size: 4 },
                { value: 250000000, size: 2 }
              ]
            }]
          }
        }

        function updateCurrentsRenderer(){

          const variableField = `${variable}_${getLevelFromDepth(depthSlider.values[0])}`;
          const velocityField = `Velocity_${getLevelFromDepth(depthSlider.values[0])}`;
          const directionField = `Direction_${getLevelFromDepth(depthSlider.values[0])}`;

          emuLayerView.filter = {
            where: `${variableField} IS NOT NULL AND ${velocityField} IS NOT NULL AND ${directionField} IS NOT NULL`
          };

          emuLayer.renderer = {
            type: "simple",
            symbol: {
              type: "web-style",
              name: "tear-pin-1",
              styleName: "Esri2DPointSymbolsStyle"
            },
            visualVariables: [{
              type: "color",
              // temp_1, temp_2, temp_3, etc.
              field: `${variable}_${getLevelFromDepth(depthSlider.values[0])}`,
              stops: [
                { value: 0, color: "#1993ff" },
                { value: 5, color: "#2e6ca4" },
                { value: 15, color: "#403031" },
                { value: 27, color: "#a6242e" },
                { value: 30, color: "#ff2638" }
              ]
            }, {
              type: "rotation",
              // Direction_1, Direction_2, Direction_3, etc.
              field: `Direction_${getLevelFromDepth(depthSlider.values[0])}`,
              rotationType: "geographic"
            }, {
              type: "size",
              // Velocity_1, Velocity_2, Velocity_3, etc.
              field: `Velocity_${getLevelFromDepth(depthSlider.values[0])}`,
              minDataValue: 0,
              maxDataValue: 0.5,
              minSize: {
                type: "size",
                valueExpression: "$view.scale",
                stops: [
                  { value: 7812500, size: "12px" },
                  { value: 15625000, size: "8px" },
                  { value: 31250000, size: "6px" },
                  { value: 62500000, size: "4px" },
                  { value: 125000000, size: "2px" },
                  { value: 250000000, size: "1px" }
                ]
              },
              maxSize: {
                type: "size",
                valueExpression: "$view.scale",
                stops: [
                  { value: 7812500, size: "32px" },
                  { value: 15625000, size: "20px" },
                  { value: 31250000, size: "16px" },
                  { value: 62500000, size: "12px" },
                  { value: 125000000, size: "6px" },
                  { value: 250000000, size: "4px" }
                ]
              }
            }]
          };
        }

        let selectedFeatures = [];

        depthSlider.on(["thumb-change", "thumb-drag"], function(){
          updateVisualization();
          // updateHistogram(selectedFeatures);
        });

        const sketchLayer = new GraphicsLayer();

        const webmap = new WebMap({
          portalItem: {
            id: "06d3dc52f5cb4ddc96825b399919e916",
            portal: {
              url: "https://qaext.arcgis.com"
            }
          },
          layers: [ emuLayer, sketchLayer ]
        });

        view = new MapView({
          map: webmap,
          container: "viewDiv",
          ui: {
            components: [ "attribution" ]
          },
          constraints: {
            snapToZoom: false
          },
          center: {
            spatialReference: {
              latestWkid: 54099,
              wkid: 54099
            },
            x: -551776,
            y: -1021353
          },
          scale: 122231056,
        });
        const zoomControl = new Zoom({ view: view })
        view.ui.add(zoomControl, "bottom-right");

        const legendExpand = new Expand({
          content: new Legend({
            view: view
          }),
          view: view,
          expanded: false,
          group: "bottom-left"
        });
        view.ui.add(legendExpand, "bottom-left");

        const draw = new Draw({
          view: view
        });

        function drawLine(){

          // creates and returns an instance of PolyLineDrawAction
          const action = draw.create("polyline");

          // focus the view to activate keyboard shortcuts for sketching
          view.focus();

          // listen polylineDrawAction events to give immediate visual feedback
          // to users as the line is being drawn on the view.
          action.on(
            [
              "vertex-add",
              "draw-complete"
            ],
            updateVertices
          );

          action.on("draw-complete", function(event){
            drawBtn.classList.remove("esri-button--secondary");
            updateVertices(event);
            deactivateButton();
          });
        }

        // Checks if the last vertex is making the line intersect itself.
        function updateVertices(event) {
          // create a polyline from returned vertices
          if (event.vertices.length > 1) {
            const result = createGraphic(event);
          }
        }

        // create a new graphic presenting the polyline that is being drawn on the view
        function createGraphic(event) {
          const vertices = event.vertices;
          view.graphics.removeAll();

          // a graphic representing the polyline that is being drawn
          const graphic = new Graphic({
            geometry: {
              type: "polyline",
              paths: vertices,
              spatialReference: view.spatialReference
            },
            symbol: {
              type: "simple-line", // autocasts as new SimpleFillSymbol
              color: "#00ff78",//[4, 90, 141],
              width: 4,
              cap: "round",
              join: "round"
            }
          });

          view.graphics.add(graphic);

          filterByGeometry(graphic.geometry, bufferSlider.values[0]);
        }

        const drawBtn = document.getElementById("draw-btn");

        drawBtn.addEventListener("click", function(event) {
          deactivateButton(drawBtn);
          drawLine();
        });

        function deactivateButton(button) {
          event.target.classList.add("esri-button--secondary");
        }

        const resetBtn = document.getElementById("reset-btn");

        resetBtn.addEventListener("click", function(){
          clearFilter();
          clearHisogram();
        })

        const bufferSlider = new Slider({
          container: document.getElementById("bufferSlider"),
          values: [ 500 ],
          min: 100,
          max: 1000,
          layout: "horizontal",
          precision: 0,
          steps: 100,
          visibleElements: {
            labels: true,
            rangeLabels: true
          }
        });

        bufferSlider.on(["thumb-change", "thumb-drag"], function(){
          if(view.graphics.length < 1){
            return;
          }

          const graphic = view.graphics.getItemAt(0);
          filterByGeometry(graphic.geometry, bufferSlider.values[0]);
        });

        const loadingControl = document.getElementById("loading-control");

        view.whenLayerView(emuLayer)
          .then(function(lv){
            emuLayerView = lv;

            const handles = disableViewInteraction(view);

            watchUtils.whenFalseOnce(emuLayerView, "updating", function(updating){
              view.container.style.opacity = "100%";
              loadingControl.style.visibility = "hidden";
              enableViewInteraction(handles);
            });

            createChart();
            updateVisualization();
          });

        view.on("pointer-move", function(event){
          if(relationshipRadio.checked){
            return;
          }
          view.hitTest(event)
            .then(function(hitResponse){
              if(hitResponse.results.length < 1){
                return;
              }

              const emuHit = hitResponse.results
                .map( result => result.graphic )
                .filter( graphic => graphic.layer && graphic.layer.title === emuLayer.title )[0];

              if(emuHit){
                lastHit = emuHit;
                updateChart(emuHit);
              }
            });
        });

        function filterByGeometry(geometry, distance){
          emuLayerView.effect = {
            excludedEffect: "grayscale(100%) opacity(80%)",
            filter: {
              geometry: geometryEngine.buffer(geometry, distance, "kilometers")
            }
          }


          const query = emuLayerView.createQuery();
          query.geometry = emuLayerView.effect.filter.geometry;

          emuLayerView.queryFeatures(query).then(function(response){
            selectedFeatures = response.features;
            return selectedFeatures;
          }).then(updateHistogram);
        }

        function buffer(geometry){
          try{
            var result = geometryEngine.geodesicBuffer(geometry, 500, "kilometers");
          } catch(e){
            console.log(e);
          }
        }

        function clearFilter(){
          const variableField = `${variable}_${getLevelFromDepth(depthSlider.values[0])}`;
          const velocityField = `Velocity_${getLevelFromDepth(depthSlider.values[0])}`;
          const directionField = `Direction_${getLevelFromDepth(depthSlider.values[0])}`;

          emuLayerView.effect = null;
          emuLayerView.filter = null;
          selectedFeatures = [];
          drawBtn.classList.remove("esri-button--secondary");
          view.graphics.removeAll();
          draw.reset();
          clearHisogram();
        }

        const cimData = {
          "type":"CIMPointSymbol",
          "symbolLayers":[
            {
              "type":"CIMVectorMarker",
              "enable":true,
              "anchorPoint":{
                "x":0,
                "y":-0.5
              },
              "anchorPointUnits":"Relative",
              "dominantSizeAxis3D":"Y",
              "size":18.5,
              "billboardMode3D":"FaceNearPlane",
              "frame":{
                "xmin":0.0,
                "ymin":0.0,
                "xmax":21.0,
                "ymax":21.0
              },
              "markerGraphics":[
                {
                  "type":"CIMMarkerGraphic",
                  "geometry":{
                    "rings":[
                      [
                        [
                          17.17,
                          14.33
                        ],
                        [
                          16.97,
                          12.96
                        ],
                        [
                          16.38,
                          11.37
                        ],
                        [
                          12.16,
                          3.98
                        ],
                        [
                          11.2,
                          1.94
                        ],
                        [
                          10.5,
                          0.0
                        ],
                        [
                          9.8,
                          1.96
                        ],
                        [
                          8.84,
                          4.02
                        ],
                        [
                          4.61,
                          11.41
                        ],
                        [
                          4.02,
                          12.98
                        ],
                        [
                          3.83,
                          14.33
                        ],
                        [
                          3.96,
                          15.63
                        ],
                        [
                          4.34,
                          16.88
                        ],
                        [
                          4.95,
                          18.03
                        ],
                        [
                          5.78,
                          19.04
                        ],
                        [
                          6.8,
                          19.88
                        ],
                        [
                          7.95,
                          20.49
                        ],
                        [
                          9.2,
                          20.87
                        ],
                        [
                          10.5,
                          21.0
                        ],
                        [
                          11.8,
                          20.87
                        ],
                        [
                          13.05,
                          20.5
                        ],
                        [
                          14.2,
                          19.88
                        ],
                        [
                          15.22,
                          19.05
                        ],
                        [
                          16.05,
                          18.03
                        ],
                        [
                          16.66,
                          16.88
                        ],
                        [
                          17.04,
                          15.63
                        ],
                        [
                          17.17,
                          14.33
                        ]
                      ]
                    ]
                  },
                  "symbol":{
                    "type":"CIMPolygonSymbol",
                    "symbolLayers":[
                      {
                        "type":"CIMSolidStroke",
                        "enable":true,
                        "capStyle":"Round",
                        "joinStyle":"Round",
                        "lineStyle3D":"Strip",
                        "miterLimit":10,
                        "width":0,
                        "color":[
                          110,
                          110,
                          110,
                          255
                        ]
                      },
                      {
                        "type":"CIMSolidFill",
                        "enable":true,
                        "color":[
                          201,
                          49,
                          0,
                          255
                        ]
                      }
                    ]
                  }
                }
              ],
              "scaleSymbolsProportionally":true,
              "respectFrame":true
            }
          ],
          "haloSize":1,
          "scaleX":1,
          "angleAlignment":"Display",
          "version":"2.0.0",
          "build":"8933"
        };

        function updateSalinityTempRelationship(addCurrents){
          const level = getLevelFromDepth(depthSlider.values[0]);

          const field1 = `salinity_${level}`;
          const field2 = `temp_${level}`;

          const renderer = rendererJsonUtils.fromJSON({
            "authoringInfo": {
              "classificationMethod": "esriClassifyQuantile",
              "field1": {
                "field": field1,
                "normalizationField": "",
                "classBreakInfos": [
                  {
                    "minValue": 5.017099857330322,
                    "maxValue": 33.93169021606445
                  },
                  {
                    "minValue": 33.93169021606445,
                    "maxValue": 34.94491195678711
                  },
                  {
                    "minValue": 34.94491195678711,
                    "maxValue": 41.148712158203125
                  }
                ]
              },
              "field2": {
                "field": field2,
                "normalizationField": "",
                "classBreakInfos": [
                  {
                    "minValue": -1.8617100715637207,
                    "maxValue": 5.463809967041016
                  },
                  {
                    "minValue": 5.463809967041016,
                    "maxValue": 22.64011001586914
                  },
                  {
                    "minValue": 22.64011001586914,
                    "maxValue": 30.277099609375
                  }
                ]
              },
              // "focus": null,
              "numClasses": 3,
              "type": "relationship"
            },
            "type": "uniqueValue",
            "valueExpression": `
              var field1 = $feature['${field1}'];
              var field2 = $feature['${field2}'];
              var hasNormField1 = false;
              var hasNormField2 = false;
              var normField1 = null;
              var normField2 = null;

              if (
                IsEmpty(field1) ||
                IsEmpty(field2) ||
                (hasNormField1 && (IsEmpty(normField1) || normField1 == 0)) ||
                (hasNormField2 && (IsEmpty(normField2) || normField2 == 0))
              ) {
                return null;
              }

              var value1 = IIf(hasNormField1, (field1 / normField1), field1);
              var value2 = IIf(hasNormField2, (field2 / normField2), field2);

              var breaks1 = [[5.017099857330322,33.93169021606445],[33.93169021606445,34.94491195678711],[34.94491195678711,41.148712158203125]];
              var breaks2 = [[-1.8617100715637207,5.463809967041016],[5.463809967041016,22.64011001586914],[22.64011001586914,30.277099609375]];
              var classCodes = [\"L\",\"M\",\"H\"];\n\n  function getClassCode(value, breaks) {
                var code = null;

                for (var i in breaks) {
                  var info = breaks[i];
                  if (value >= info[0] && value <= info[1]) {
                    code = classCodes[i];\
                    break;
                  }
                }

                return code;
              }

              var code1 = getClassCode(value1, breaks1);
              var code2 = getClassCode(value2, breaks2);\

              var classValue = IIf(IsEmpty(code1) || IsEmpty(code2), null, code1 + code2);
              return classValue;
            `,
            "valueExpressionTitle": "Relationship",
            "legendOptions": {},
            "uniqueValueInfos": [
              {
                "label": "High Salinity - Warm",
                "symbol": {
                  "type": "esriSMS",
                  "color": [
                    89,
                    63,
                    179,
                    255
                  ],
                  "angle": 0,
                  "xoffset": 0,
                  "yoffset": 0,
                  "size": 4,
                  "style": "esriSMSCircle",
                  "outline": {
                    "type": "esriSLS",
                    "color": [
                      153,
                      153,
                      153,
                      64
                    ],
                    "width": 0.75,
                    "style": "esriSLSSolid"
                  }
                },
                "value": "HH"
              },
              {
                "label": "High - Medium",
                "symbol": {
                  "type": "esriSMS",
                  "color": [
                    148,
                    92,
                    144,
                    255
                  ],
                  "angle": 0,
                  "xoffset": 0,
                  "yoffset": 0,
                  "size": 4,
                  "style": "esriSMSCircle",
                  "outline": {
                    "type": "esriSLS",
                    "color": [
                      153,
                      153,
                      153,
                      64
                    ],
                    "width": 0.75,
                    "style": "esriSLSSolid"
                  }
                },
                "value": "HM"
              },
              {
                "label": "High Salinity - Cold",
                "symbol": {
                  "type": "esriSMS",
                  "color": [
                    255,
                    115,
                    115,
                    255
                  ],
                  "angle": 0,
                  "xoffset": 0,
                  "yoffset": 0,
                  "size": 4,
                  "style": "esriSMSCircle",
                  "outline": {
                    "type": "esriSLS",
                    "color": [
                      153,
                      153,
                      153,
                      64
                    ],
                    "width": 0.75,
                    "style": "esriSLSSolid"
                  }
                },
                "value": "HL"
              },
              {
                "label": "Medium - High",
                "symbol": {
                  "type": "esriSMS",
                  "color": [
                    85,
                    147,
                    212,
                    255
                  ],
                  "angle": 0,
                  "xoffset": 0,
                  "yoffset": 0,
                  "size": 4,
                  "style": "esriSMSCircle",
                  "outline": {
                    "type": "esriSLS",
                    "color": [
                      153,
                      153,
                      153,
                      64
                    ],
                    "width": 0.75,
                    "style": "esriSLSSolid"
                  }
                },
                "value": "MH"
              },
              {
                "label": "Medium - Medium",
                "symbol": {
                  "type": "esriSMS",
                  "color": [
                    166,
                    153,
                    212,
                    255
                  ],
                  "angle": 0,
                  "xoffset": 0,
                  "yoffset": 0,
                  "size": 4,
                  "style": "esriSMSCircle",
                  "outline": {
                    "type": "esriSLS",
                    "color": [
                      153,
                      153,
                      153,
                      64
                    ],
                    "width": 0.75,
                    "style": "esriSLSSolid"
                  }
                },
                "value": "MM"
              },
              {
                "label": "Medium - Low",
                "symbol": {
                  "type": "esriSMS",
                  "color": [
                    249,
                    184,
                    184,
                    255
                  ],
                  "angle": 0,
                  "xoffset": 0,
                  "yoffset": 0,
                  "size": 4,
                  "style": "esriSMSCircle",
                  "outline": {
                    "type": "esriSLS",
                    "color": [
                      153,
                      153,
                      153,
                      64
                    ],
                    "width": 0.75,
                    "style": "esriSLSSolid"
                  }
                },
                "value": "ML"
              },
              {
                "label": "Low Salinity - Warm",
                "symbol": {
                  "type": "esriSMS",
                  "color": [
                    98,
                    231,
                    245,
                    255
                  ],
                  "angle": 0,
                  "xoffset": 0,
                  "yoffset": 0,
                  "size": 4,
                  "style": "esriSMSCircle",
                  "outline": {
                    "type": "esriSLS",
                    "color": [
                      153,
                      153,
                      153,
                      64
                    ],
                    "width": 0.75,
                    "style": "esriSLSSolid"
                  }
                },
                "value": "LH"
              },
              {
                "label": "Low - Medium",
                "symbol": {
                  "type": "esriSMS",
                  "color": [
                    163,
                    236,
                    244,
                    255
                  ],
                  "angle": 0,
                  "xoffset": 0,
                  "yoffset": 0,
                  "size": 4,
                  "style": "esriSMSCircle",
                  "outline": {
                    "type": "esriSLS",
                    "color": [
                      153,
                      153,
                      153,
                      64
                    ],
                    "width": 0.75,
                    "style": "esriSLSSolid"
                  }
                },
                "value": "LM"
              },
              {
                "label": "Low Salinity, Cold",
                "symbol": {
                  "type": "esriSMS",
                  "color": [
                    242,
                    242,
                    242,
                    255
                  ],
                  "angle": 0,
                  "xoffset": 0,
                  "yoffset": 0,
                  "size": 4,
                  "style": "esriSMSCircle",
                  "outline": {
                    "type": "esriSLS",
                    "color": [
                      153,
                      153,
                      153,
                      64
                    ],
                    "width": 0.75,
                    "style": "esriSLSSolid"
                  }
                },
                "value": "LL"
              }
            ]
          });

          renderer.visualVariables = [{
            type: "size",
            valueExpression: "$view.scale",
            stops: [
              { value: 7812500, size: 12 },
              { value: 15625000, size: 10 },
              { value: 31250000, size: 6 },
              { value: 62500000, size: 4 },
              { value: 125000000, size: 4 },
              { value: 250000000, size: 2 }
            ]
          }];

          if(addCurrents){
            const velocityField = `Velocity_${getLevelFromDepth(depthSlider.values[0])}`;
            const directionField = `Direction_${getLevelFromDepth(depthSlider.values[0])}`;

            const visualVariables = [{
              type: "size",
              legendOptions: {
                showLegend: false
              },
              // Velocity_1, Velocity_2,
              field: velocityField,
              minDataValue: 0,
              maxDataValue: 0.5,
              minSize: {
                type: "size",
                valueExpression: "$view.scale",
                stops: [
                  { value: 7812500, size: "12px" },
                  { value: 15625000, size: "8px" },
                  { value: 31250000, size: "6px" },
                  { value: 62500000, size: "4px" },
                  { value: 125000000, size: "2px" },
                  { value: 250000000, size: "1px" }
                ]
              },
              maxSize: {
                type: "size",
                valueExpression: "$view.scale",
                stops: [
                  { value: 7812500, size: "32px" },
                  { value: 15625000, size: "20px" },
                  { value: 31250000, size: "16px" },
                  { value: 62500000, size: "12px" },
                  { value: 125000000, size: "6px" },
                  { value: 250000000, size: "4px" }
                ]
              }
            }, {
              type: "rotation",
              legendOptions: {
                showLegend: false
              },
              field: directionField,
              // valueExpression: `$feature.${directionField} - 180`,
              rotationType: "geographic"
            }];

            renderer.uniqueValueInfos.forEach(function(info){
              const color = info.symbol.color;

              const symbolData = lang.clone(cimData);
              symbolData.symbolLayers[0].markerGraphics[0].symbol.symbolLayers[1].color = color.toJSON();

              const symbol = new CIMSymbol({
                data: symbolData
              });

              info.symbol = symbol;
            });

            renderer.visualVariables = visualVariables;
          }

          emuLayer.renderer = renderer;
        }

        let scatterChart = null;
        let pointBackgroundColors = [];

        function createChart(){
          const chartCanvas = document.getElementById("line-chart");
          let xMin = 0;
          let xMax = 30;

          scatterChart = new Chart(chartCanvas.getContext("2d"), {
            type: 'scatter',
            data: {
              datasets: [{
                label: variable,
                pointRadius: 4,
                pointBackgroundColor: pointBackgroundColors,
                data: [{
                  x: 0,
                  y: 0
                }]
              }]
            },
            options: {
              responsive: true,
              legend: {
                display: false
              },
              scales: {
                xAxes: [{
                    type: 'linear',
                    position: 'top',
                    ticks: {
                      min: variableConfig[variable].chartOptions.min,
                      max: variableConfig[variable].chartOptions.max
                    }
                }],
                yAxes: [{
                  ticks: {
                    min: -3500,
                    max: 0,
                  }
                }]
              }
            }
        });

        }

      function updateChart(graphic){
        if(!scatterChart){
          createChart();
          return;
        }

        if(!graphic){
          scatterChart.data.datasets[0].data = [];
          scatterChart.update();
          return;
        }

        const attributes = graphic.attributes;
        let data = [];

        for (let key in attributes){
          const splitName = key.split("_");
          const variableName = splitName[0];
          const depthLevel = splitName[1];
          if (key.indexOf(variable) > -1){
            data.push({
              x: attributes[key],
              y: depthValues[depthLevel-1]
            });
          }
        }
        scatterChart.data.datasets[0].data = data;
        scatterChart.data.datasets[0].label = variable;
        scatterChart.data.datasets[0].backgroundColor = variableConfig[variable].colors[2];

        for (i = 0; i < scatterChart.data.datasets[0].data.length; i++) {
          const value = scatterChart.data.datasets[0].data[i].x;
          if(value){
            const color = getColorFromValue(value);
            pointBackgroundColors[i] = color.toHex();
          }
        }

        scatterChart.options.scales.xAxes = [{
          type: 'linear',
          position: 'top',
          ticks: {
            min: variableConfig[variable].chartOptions.min,
            max: variableConfig[variable].chartOptions.max
          }
        }];
        scatterChart.update();
      }

      function getAverage(params) {
        return summaryStatistics(params).then(function(statistics) {
          return statistics.avg;
        });
      }

      function clearHisogram(){
        if(histogramChart){
          histogramChart.bins = [];
          histogramMinElement.innerText = "";
          histogramMaxElement.innerText = "";
          histogramTitle.innerText = "";
        }
      }

      function updateHistogram(features) {

        if(!features || features.length < 1){
          return;
        }

        const variableField = `${variable}_${getLevelFromDepth(depthSlider.values[0])}`;

        // params for generating a histogram using the
        // points available on the client

        const params = {
          layer: emuLayer,
          field: variableField,
          view: view,
          features: features,
          numBins: 100,
          minValue: variableConfig[variable].chartOptions.min,
          maxValue: variableConfig[variable].chartOptions.max
        };

        let average = null;

        getAverage(params)
          .then(function(avg) {
            average = avg;
            return histogram(params);
          })
          .then(function(histogramResult) {
            // cache previously used histograms to improve performance
            const bins = histogramResult.bins
            // histograms[variableField] = bins;

            if (variable === "temp"){
              histogramMinElement.innerText = histogramResult.minValue.toFixed(2) + "째 C";
              histogramMaxElement.innerText = histogramResult.maxValue.toFixed(2) + "째 C";
              histogramTitle.innerText = "Temperature (째C)";
            } else {
              histogramMinElement.innerText = histogramResult.minValue.toFixed(2);
              histogramMaxElement.innerText = histogramResult.maxValue.toFixed(2);
              histogramTitle.innerText = "Salinity";
            }

            if (!histogramChart) {
              histogramChart = new Histogram({
                container: "histogram",
                min: histogramResult.minValue,
                max: histogramResult.maxValue,
                bins: histogramResult.bins,
                average: average,
                dataLineCreatedFunction: function(element, label, index) {
                  if (index === 0) {
                    element.setAttribute("y2", "75%");
                  }
                },
                labelFormatFunction: function(value, type) {
                  return type === "average" ? value.toFixed(2) : value;
                },
                barCreatedFunction: function(index, element) {
                  const bin = histogramChart.bins[index];
                  const midValue = (bin.maxValue - bin.minValue) / 2 + bin.minValue;
                  if(midValue){
                    const color = getColorFromValue(midValue);
                    element.setAttribute("fill", color.toHex());
                  }
                  binElements[index] = element;
                }
              });
            } else {
              histogramChart.bins = bins;
              histogramChart.average = average;
              histogramChart.min = histogramResult.minValue;
              histogramChart.max = histogramResult.maxValue;

              binElements.forEach(function(element, i){
                const bin = bins[i];
                const midValue = (bin.maxValue - bin.minValue) / 2 + bin.minValue;
                if(midValue){
                  const color = getColorFromValue(midValue);
                  element.setAttribute("fill", color.toHex());
                }
              });
            }
          })
          .catch(function(e) {
            console.error(e);
          });
      }

      // Infers the color of the visual variable based on a given value
      // This is used to render and update histogram bars with colors
      // matching the features in the map
      function getColorFromValue(value) {
        const visualVariable = emuLayer.renderer.visualVariables.filter(function(
          vv
        ) {
          return vv.type === "color";
        })[0];

        if(!visualVariable){
          return;
        }

        const stops = visualVariable.stops;

        let minStop = stops[0];
        let maxStop = stops[stops.length - 1];

        let minStopValue = minStop.value;
        let maxStopValue = maxStop.value;

        if (value < minStopValue) {
          return minStop.color;
        }

        if (value > maxStopValue) {
          return maxStop.color;
        }

        const exactMatches = stops.filter(function(stop) {
          return stop.value === value;
        });

        if (exactMatches.length > 0) {
          return exactMatches[0].color;
        }

        minStop = null;
        maxStop = null;

        stops.forEach(function(stop, i) {
          if (!minStop && !maxStop && stop.value >= value) {
            minStop = stops[i - 1];
            maxStop = stop;
          }
        });

        const weightedPosition = (value - minStop.value) / (maxStop.value - minStop.value);

        return Color.blendColors(
          minStop.color,
          maxStop.color,
          weightedPosition
        );
      }

      function disableViewInteraction(view) {
        const disabledHandles = [];

        // stops propagation of default behavior when an event fires
        function stopEvtPropagation(event) {
          event.stopPropagation();
        }

        if(zoomControl){
          zoomControl.container.style.visibility = "hidden";
        }

        // disable mouse wheel scroll zooming on the view
        const mouseWheelHandle = view.on("mouse-wheel", stopEvtPropagation);

        // disable zooming via double-click on the view
        const doubleClickHandle = view.on("double-click", stopEvtPropagation);

        // disable zooming out via double-click + Control on the view
        const doubleClickControlHandle = view.on("double-click", ["Control"], stopEvtPropagation);

        // disables pinch-zoom and panning on the view
        const dragHandle = view.on("drag", stopEvtPropagation);

        // disable the view's zoom box to prevent the Shift + drag
        // and Shift + Control + drag zoom gestures.
        const dragShiftHandle = view.on("drag", ["Shift"], stopEvtPropagation);
        const dragShiftCntrlHandle = view.on("drag", ["Shift", "Control"], stopEvtPropagation);

        // prevents zooming with the + and - keys
        const keyDownHandle = view.on("key-down", function(event) {
          var prohibitedKeys = ["+", "-", "Shift", "_", "="];
          var keyPressed = event.key;
          if (prohibitedKeys.indexOf(keyPressed) !== -1) {
            event.stopPropagation();
          }
        });

        return [
          mouseWheelHandle,
          doubleClickHandle,
          doubleClickControlHandle,
          dragHandle,
          dragShiftHandle,
          dragShiftCntrlHandle,
          keyDownHandle
        ];
      }

      function enableViewInteraction(handles){
        if(zoomControl){
          zoomControl.container.style.visibility = "visible";
        }
        handles.forEach(function(handle){
          handle.remove();
        });
        handles = [];
      }

      const bookmarks = new Bookmarks({
        view: view,
        bookmarks: [
          new Bookmark({
            name: "World",
            extent: {
              spatialReference: {
                latestWkid: 54099,
                wkid: 54099
              },
              xmin: -17546006.114587966,
              ymin: -13796049.80015584,
              xmax: 15796910.111811157,
              ymax: 11041350.45384467
                          }
            }),
          new Bookmark({
            name: "Equatorial Currents",
            extent: {
              spatialReference: {
                latestWkid: 54099,
                wkid: 54099
              },
              xmin: -9331161.138770934,
              ymin: 821918.3497348882,
              xmax: -5068880.478792946,
              ymax: 3996924.6997475885
                          }
            }),
          new Bookmark({
            name: "Agulhas Current",
            extent: {
              spatialReference: {
                latestWkid: 54099,
                wkid: 54099
              },
              xmin: -3919897.7138591977,
              ymin: -773166.8475296779,
              xmax: 1945372.616901,
              ymax: 3595919.102056968
            }
          }),
          new Bookmark({
            name: "Gulf Stream",
            extent: {
              spatialReference: {
                latestWkid: 54099,
                wkid: 54099
              },
              xmin: -14980844.14269451,
              ymin: 4454228.417656096,
              xmax: -5820309.4512356715,
              ymax: 11277982.678607006
            }
          })
        ]
      });

      view.ui.add(new Expand({
        view: view,
        content: bookmarks
      }), "top-left");

    });
  </script>
</head>

<body>
  <div id="viewDiv">
    <div id="loading-control" class="esri-widget">
      Hold on while we load data the size of an ocean...
      <div class="lds-grid"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div>
    </div>
  </div>

  <div id="options" class="esri-widget">

    <div id="titleDiv" class="esri-widget">
      <div id="titleText">One Ocean</div>
      <div id="dataDescription">Explore temperature and salinity in the world's oceans</div>
    </div>

    <div class="options-top">
      <div class="options-top-left">

        <calcite-radio-group id="variable-select" scale="l" role="radiogroup" theme="light" class="hydrated">
          <calcite-radio-group-item id="salinity-radio" value="salinity" checked="" tabindex="0" role="radio" aria-checked="true" scale="l" class="hydrated">Salinity</calcite-radio-group-item>
          <calcite-radio-group-item id="temp-radio" value="temp" tabindex="-1" role="radio" aria-checked="false" scale="l" class="hydrated">Temperature</calcite-radio-group-item>
          <calcite-radio-group-item id="relationship-radio" value="relationship" tabindex="-1" role="radio" aria-checked="false" scale="l" class="hydrated">Salinity & Temperature</calcite-radio-group-item>
        </calcite-radio-group>

        <div style="padding: 10px;" class="esri-widget">
          <label> <calcite-switch id="currents-checkbox" switched="false"></calcite-switch> Show currents</label>
        </div>
      </div>
      <div class="options-top-right">
        <div id="verticalDiv" class="esri-widget">
          <div class="subtitle">
            Depth
          </div>
          <div id="depthSliderContainer">
            <div id="depthSlider"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="options-bottom">

      <calcite-tabs>
        <calcite-tab-nav slot="tab-nav">
          <calcite-tab-title is-active>Depth profile</calcite-tab-title>
          <calcite-tab-title>Filter tools</calcite-tab-title>
        </calcite-tab-nav>

        <calcite-tab is-active>
          <div id="depth-profile-title" class="subtitle">
            Depth profile
          </div>
          <div id="chartContainer" class="esri-widget">
            <canvas id="line-chart" style="width:100%; height:100%;"></canvas>
          </div>
        </calcite-tab>

        <calcite-tab>
          <div style="display: flex; flex-direction: row; background-color: #fff">
            <button id="draw-btn" data-type="polyline" class="esri-button">
              Filter along a path
            </button>
            <button id="reset-btn" class="esri-button">
              Reset filter
            </button>
          </div>
          <div id="bufferSliderContainer">
            <div id="distance-subtitle" class="subtitle">
              Within a distance (km) of...
            </div>
            <div id="bufferSlider"></div>
          </div>
          <div class="esri-widget">
            <div id="title" class="esri-widget">
              <h3><span id="histogram-title">Histogram</span></h3>
            </div>
            <div id="histogram" class="esri-widget"></div>
            <div class="labels esri-widget">
              <span style="float: left"><span id="histogram-min-label"></span></span>
              <span style="float: right"><span id="histogram-max-label"></span></span>
            </div>
          </div>
        </calcite-tab>
      </calcite-tabs>
    </div>
  </div>

  <div id="variable-depth-display" class="esri-widget">
    <div id="variable-display"></div>
    <div id="depth-display"></div>
  </div>
</body>
</html>
