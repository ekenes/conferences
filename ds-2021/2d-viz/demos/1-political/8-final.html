<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="initial-scale=1,maximum-scale=1,user-scalable=no"
  />

  <title>Create a custom visualization using Arcade - 4.14</title>

  <link
    rel="stylesheet"
    href="https://js.arcgis.com/4.14/esri/themes/dark/main.css"
  />
  <script src="https://js.arcgis.com/4.14/"></script>

  <style>
    html,
    body,
    #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
    }
  </style>

  <script>
    require([
      "esri/Map",
      "esri/views/MapView",
      "esri/layers/FeatureLayer",
      "esri/widgets/Legend"
    ], function(Map, MapView, FeatureLayer, Legend) {

      const year = 2020;

      const renderer = {
        type: "unique-value",
        valueExpression: `
          var r = $feature.rep_${year};
          var d = $feature.dem_${year};
          var o = $feature.oth_${year};
          var all = [r, d, o];

          return Decode( Max(all),
            r, 'Republican',
            d, 'Democrat',
            o, 'Other',
          'n/a' );
        `,
        valueExpressionTitle: "Winner",
        uniqueValueInfos: [
          {
            value: "Democrat",
            symbol: createSymbol("#00c3ff", "simple-marker"),
            label: "Biden"
          },
          {
            value: "Republican",
            symbol: createSymbol("#ff002e", "simple-marker"),
            label: "Trump"
          },
          {
            value: "Other",
            symbol: createSymbol("#faff00", "simple-marker"),
            label: "Other"
          }
        ],
        visualVariables: [{
          type: "opacity",
          valueExpression: `
            var r = $feature.rep_${year};
            var d = $feature.dem_${year};
            var o = $feature.oth_${year};
            var all = [r, d, o];

            var total = Sum(all);
            var max = Max(all);

            return (max / total) * 100;
          `,
          valueExpressionTitle:
            "% of total votes earned",
          stops: [
            { value: 40, opacity: 0.05, label: "< 40%" },
            { value: 75, opacity: 1.0, label: "> 75%" }
          ]
        }, {
          type: "size",
          valueExpression: `
            var r = $feature.rep_${year};
            var d = $feature.dem_${year};
            var o = $feature.oth_${year};
            var all = [r, d, o];

            var total = Sum(all);

            return total;
          `,
          valueExpressionTitle: "Total votes",
          minDataValue: 100,
          minSize: 4,
          maxDataValue: 3000000,
          maxSize: 40
        }]
      };

      const layer = new FeatureLayer({
        portalItem: {
          id: "d579b818c80145ca894c45f53c639e30"
        },
        renderer: renderer,
        popupTemplate: {
          title: "{COUNTY}, {STATE}",
          content: [
            {
              type: "fields",
              fieldInfos: [
                {
                  fieldName: `dem_${year}`,
                  label: "Democrat",
                  format: {
                    digitSeparator: true,
                    places: 0
                  }
                },
                {
                  fieldName: `rep_${year}`,
                  label: "Republican",
                  format: {
                    digitSeparator: true,
                    places: 0
                  }
                },
                {
                  fieldName: `oth_${year}`,
                  label: "Other",
                  format: {
                    digitSeparator: true,
                    places: 0
                  }
                }
              ]
            }
          ]
        }
      });

      const map = new Map({
        basemap: {
          portalItem: {
            id: "4f2e99ba65e34bb8af49733d9778fb8e"
          }
        },
        layers: [ layer ]
      });

      // The minSize and maxSize of volumetric symbols are determined
      // based on the view/camera the data will be displayed in.

      const view = new MapView({
        container: "viewDiv",
        map: map,
        center: [-95, 38],
        zoom: 4
      });

      const legend = new Legend({
        view
      });
      view.ui.add(legend, "bottom-left");

      // Creates a SimpleFillSymbol based on an input color

      function createSymbol(color, type) {
        return {
          type: type || "simple-fill", // autocasts as new SimpleFillSymbol()
          color: color,
          // style: "square",
          outline: {
            width: 0.5,
            color: [0, 0, 0, 0.2]
          }
        };
      }
    });
  </script>
</head>

<body>
  <div id="viewDiv"></div>
</body>
</html>